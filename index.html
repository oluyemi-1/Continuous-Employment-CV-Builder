import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Download, AlertCircle, Share2, Lightbulb, Save } from 'lucide-react';

export default function CVBuilder() {
  const [personalInfo, setPersonalInfo] = useState({
    fullName: '',
    email: '',
    phone: '',
    address: '',
    postcode: '',
    dateOfBirth: '',
    currentAge: '',
    age16Date: ''
  });

  const [entries, setEntries] = useState([]);
  const [gaps, setGaps] = useState([]);
  const [customTypes, setCustomTypes] = useState([]);
  const [showCustomTypeModal, setShowCustomTypeModal] = useState(false);
  const [newCustomType, setNewCustomType] = useState('');
  const [showGapSuggestions, setShowGapSuggestions] = useState(false);
  const [currentGap, setCurrentGap] = useState(null);
  const [unsavedEntry, setUnsavedEntry] = useState(null);
  const [showSavePrompt, setShowSavePrompt] = useState(false);

  const defaultTypes = [
    'employment',
    'education',
    'unemployment',
    'job seeking',
    'gap year',
    'travel',
    'self-employed',
    'volunteer',
    'career break',
    'parental leave',
    'sabbatical',
    'freelancing'
  ];

  const allTypes = [...defaultTypes, ...customTypes];

  const calculateAge = (dob) => {
    if (!dob) return { age: '', age16Date: '' };
    const today = new Date();
    const birthDate = new Date(dob);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    const age16 = new Date(birthDate);
    age16.setFullYear(age16.getFullYear() + 16);
    const age16DateStr = age16.toISOString().split('T')[0];
    
    return { age, age16Date: age16DateStr };
  };

  const handleDOBChange = (dob) => {
    const { age, age16Date } = calculateAge(dob);
    setPersonalInfo({ ...personalInfo, dateOfBirth: dob, currentAge: age, age16Date });
  };

  const getNextExpectedDate = () => {
    if (!personalInfo.age16Date) return null;
    
    if (entries.length === 0) {
      return personalInfo.age16Date;
    }
    
    const sortedEntries = [...entries].sort((a, b) => 
      new Date(b.startDate) - new Date(a.startDate)
    );
    
    const latestEntry = sortedEntries[0];
    if (latestEntry.isCurrent) return null;
    
    const endDate = new Date(latestEntry.endDate);
    endDate.setDate(endDate.getDate() + 1);
    return endDate.toISOString().split('T')[0];
  };

  const validateEntry = (entry) => {
    const errors = [];
    
    if (!entry.title?.trim()) errors.push('Job Title/Activity is required');
    if (!entry.company?.trim()) errors.push('Company/Institution is required');
    if (!entry.startDate) errors.push('Start Date is required');
    if (!entry.isCurrent && !entry.endDate) errors.push('End Date is required (or check Current)');
    if (!entry.description?.trim()) errors.push('Description is required');
    
    const expectedDate = getNextExpectedDate();
    if (expectedDate && entry.startDate) {
      const entryStart = new Date(entry.startDate);
      const expected = new Date(expectedDate);
      const diffDays = Math.abs((entryStart - expected) / (1000 * 60 * 60 * 24));
      
      if (diffDays > 14) {
        errors.push(`Start date should be within 14 days of ${expectedDate}. Current gap: ${Math.floor(diffDays)} days`);
      }
    }
    
    if (entry.startDate && entry.endDate && !entry.isCurrent) {
      if (new Date(entry.endDate) < new Date(entry.startDate)) {
        errors.push('End date cannot be before start date');
      }
    }
    
    return errors;
  };

  const addEntry = () => {
    const expectedDate = getNextExpectedDate();
    const newEntry = {
      id: Date.now(),
      type: 'employment',
      title: '',
      company: '',
      location: '',
      startDate: expectedDate || '',
      endDate: '',
      isCurrent: false,
      description: '',
      isNew: true
    };
    
    setEntries([newEntry, ...entries]);
    setUnsavedEntry(newEntry.id);
  };

  const updateEntry = (id, field, value) => {
    setEntries(entries.map(entry => {
      if (entry.id === id) {
        if (field === 'isCurrent') {
          return { ...entry, isCurrent: value, endDate: value ? '' : entry.endDate };
        }
        return { ...entry, [field]: value };
      }
      return entry;
    }));
    
    if (unsavedEntry === id) {
      setShowSavePrompt(true);
    }
  };

  const saveEntry = (id) => {
    const entry = entries.find(e => e.id === id);
    if (!entry) return;
    
    const errors = validateEntry(entry);
    if (errors.length > 0) {
      alert('Please fix the following errors:\n\n' + errors.join('\n'));
      return;
    }
    
    setEntries(entries.map(e => 
      e.id === id ? { ...e, isNew: false } : e
    ));
    setUnsavedEntry(null);
    setShowSavePrompt(false);
    
    alert('Entry saved successfully!');
    checkForGaps();
  };

  const deleteEntry = (id) => {
    if (window.confirm('Are you sure you want to delete this entry?')) {
      setEntries(entries.filter(entry => entry.id !== id));
      if (unsavedEntry === id) {
        setUnsavedEntry(null);
        setShowSavePrompt(false);
      }
    }
  };

  const getGapSuggestion = (gap, previousEntry, nextEntry) => {
    const gapDuration = gap.days;
    
    if (previousEntry?.type === 'education' && nextEntry?.type === 'employment') {
      return {
        type: 'job seeking',
        title: 'Job Search Period',
        company: 'N/A',
        description: 'Actively searching for employment opportunities after completing education'
      };
    }
    
    if (previousEntry?.type === 'employment' && nextEntry?.type === 'employment') {
      if (gapDuration < 90) {
        return {
          type: 'job seeking',
          title: 'Career Transition',
          company: 'N/A',
          description: 'Period of job search and career transition between positions'
        };
      } else {
        return {
          type: 'career break',
          title: 'Career Break',
          company: 'N/A',
          description: 'Planned career break for personal development and exploration'
        };
      }
    }
    
    if (previousEntry?.type === 'education') {
      return {
        type: 'job seeking',
        title: 'Graduate Job Search',
        company: 'N/A',
        description: 'Seeking employment opportunities as a recent graduate'
      };
    }
    
    if (gapDuration < 60) {
      return {
        type: 'unemployment',
        title: 'Between Positions',
        company: 'N/A',
        description: 'Brief period between positions'
      };
    }
    
    return {
      type: 'unemployment',
      title: 'Unemployed',
      company: 'N/A',
      description: 'Period of unemployment'
    };
  };

  const fillGapWithSuggestion = (gap) => {
    const sortedEntries = [...entries].sort((a, b) => 
      new Date(a.startDate) - new Date(b.startDate)
    );
    
    const gapStartDate = new Date(gap.start);
    let previousEntry = null;
    let nextEntry = null;
    
    for (let i = sortedEntries.length - 1; i >= 0; i--) {
      const endDate = sortedEntries[i].isCurrent ? new Date() : new Date(sortedEntries[i].endDate);
      if (endDate <= gapStartDate) {
        previousEntry = sortedEntries[i];
        break;
      }
    }
    
    for (let i = 0; i < sortedEntries.length; i++) {
      const startDate = new Date(sortedEntries[i].startDate);
      if (startDate >= gapStartDate) {
        nextEntry = sortedEntries[i];
        break;
      }
    }
    
    const suggestion = getGapSuggestion(gap, previousEntry, nextEntry);
    setCurrentGap({ ...gap, suggestion });
    setShowGapSuggestions(true);
  };

  const applyGapSuggestion = () => {
    if (!currentGap) return;
    
    const newEntry = {
      id: Date.now(),
      type: currentGap.suggestion.type,
      title: currentGap.suggestion.title,
      company: currentGap.suggestion.company,
      location: '',
      startDate: currentGap.start,
      endDate: currentGap.end,
      isCurrent: false,
      description: currentGap.suggestion.description,
      isNew: false
    };
    
    setEntries([...entries, newEntry]);
    setShowGapSuggestions(false);
    setCurrentGap(null);
  };

  const addCustomType = () => {
    if (newCustomType.trim() && !allTypes.includes(newCustomType.toLowerCase())) {
      setCustomTypes([...customTypes, newCustomType.toLowerCase()]);
      setNewCustomType('');
      setShowCustomTypeModal(false);
    }
  };

  const checkForGaps = () => {
    if (!personalInfo.dateOfBirth || entries.length === 0) return;

    const startDate = new Date(personalInfo.dateOfBirth);
    startDate.setFullYear(startDate.getFullYear() + 16);

    const sortedEntries = [...entries].sort((a, b) => 
      new Date(a.startDate) - new Date(b.startDate)
    );

    const foundGaps = [];
    let currentDate = startDate;

    sortedEntries.forEach((entry) => {
      const entryStart = new Date(entry.startDate);
      
      if (entryStart > currentDate) {
        const gapDays = Math.floor((entryStart - currentDate) / (1000 * 60 * 60 * 24));
        if (gapDays > 0) {
          foundGaps.push({
            start: currentDate.toISOString().split('T')[0],
            end: new Date(entryStart.getTime() - 86400000).toISOString().split('T')[0],
            days: gapDays
          });
        }
      }

      currentDate = entry.isCurrent ? new Date() : new Date(entry.endDate);
      currentDate.setDate(currentDate.getDate() + 1);
    });

    const today = new Date();
    if (currentDate < today) {
      const gapDays = Math.floor((today - currentDate) / (1000 * 60 * 60 * 24));
      if (gapDays > 0) {
        foundGaps.push({
          start: currentDate.toISOString().split('T')[0],
          end: today.toISOString().split('T')[0],
          days: gapDays
        });
      }
    }

    setGaps(foundGaps);
  };

  const generatePDFContent = () => {
    const sortedEntries = [...entries].sort((a, b) => 
      new Date(b.startDate) - new Date(a.startDate)
    );

    const employmentEntries = sortedEntries.filter(e => e.type !== 'education');
    const educationEntries = sortedEntries.filter(e => e.type === 'education');

    let content = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>${personalInfo.fullName} - CV</title>
          <style>
            @page { size: A4; margin: 20mm; }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              line-height: 1.6;
              color: #333;
              background: white;
              padding: 20px;
            }
            .container { max-width: 800px; margin: 0 auto; }
            h1 { 
              color: #2563eb;
              font-size: 32px;
              border-bottom: 4px solid #2563eb;
              padding-bottom: 12px;
              margin-bottom: 20px;
            }
            h2 { 
              color: #1e40af;
              font-size: 24px;
              margin-top: 30px;
              margin-bottom: 20px;
              border-bottom: 2px solid #e5e7eb;
              padding-bottom: 8px;
            }
            .personal-info { 
              margin-bottom: 30px;
              background: #f8fafc;
              padding: 20px;
              border-radius: 8px;
              border-left: 4px solid #2563eb;
            }
            .personal-info p { margin-bottom: 8px; font-size: 14px; }
            .personal-info strong {
              color: #1e40af;
              display: inline-block;
              width: 120px;
            }
            .entry { 
              margin-bottom: 25px;
              page-break-inside: avoid;
              border-left: 3px solid #e5e7eb;
              padding-left: 20px;
            }
            .entry-header { 
              font-weight: bold;
              font-size: 18px;
              color: #1e40af;
              margin-bottom: 5px;
            }
            .entry-meta { color: #666; font-size: 14px; margin-bottom: 10px; }
            .entry-company { font-weight: 600; color: #374151; }
            .entry-dates { color: #6b7280; font-style: italic; }
            .entry-type {
              display: inline-block;
              background: #dbeafe;
              color: #1e40af;
              padding: 2px 8px;
              border-radius: 4px;
              font-size: 12px;
              margin-left: 8px;
              text-transform: capitalize;
            }
            .description { 
              margin-top: 10px;
              line-height: 1.7;
              color: #4b5563;
              font-size: 14px;
            }
            .footer {
              margin-top: 40px;
              padding-top: 20px;
              border-top: 2px solid #e5e7eb;
              text-align: center;
              color: #9ca3af;
              font-size: 12px;
            }
            @media print {
              body { padding: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${personalInfo.fullName}</h1>
            <div class="personal-info">
              <p><strong>Email:</strong> ${personalInfo.email}</p>
              <p><strong>Phone:</strong> ${personalInfo.phone}</p>
              <p><strong>Address:</strong> ${personalInfo.address}</p>
              <p><strong>Postcode:</strong> ${personalInfo.postcode}</p>
              <p><strong>Date of Birth:</strong> ${personalInfo.dateOfBirth} (Age: ${personalInfo.currentAge})</p>
            </div>
            
            <h2>Employment History (Age 16 to Present)</h2>
    `;

    employmentEntries.forEach(entry => {
      const typeLabel = entry.type !== 'employment' 
        ? `<span class="entry-type">${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</span>`
        : '';
      
      content += `
        <div class="entry">
          <div class="entry-header">${entry.title} ${typeLabel}</div>
          <div class="entry-meta">
            <span class="entry-company">${entry.company}</span>${entry.location ? `, ${entry.location}` : ''}<br>
            <span class="entry-dates">${entry.startDate} - ${entry.isCurrent ? 'Present' : entry.endDate}</span>
          </div>
          ${entry.description ? `<div class="description">${entry.description}</div>` : ''}
        </div>
      `;
    });

    if (educationEntries.length > 0) {
      content += '<h2>Education</h2>';
      educationEntries.forEach(entry => {
        content += `
          <div class="entry">
            <div class="entry-header">${entry.title}</div>
            <div class="entry-meta">
              <span class="entry-company">${entry.company}</span>${entry.location ? `, ${entry.location}` : ''}<br>
              <span class="entry-dates">${entry.startDate} - ${entry.isCurrent ? 'Present' : entry.endDate}</span>
            </div>
            ${entry.description ? `<div class="description">${entry.description}</div>` : ''}
          </div>
        `;
      });
    }

    const today = new Date().toLocaleDateString('en-GB', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });

    content += `
            <div class="footer">
              <p>Curriculum Vitae - Generated on ${today}</p>
              <p>Complete continuous employment history with no gaps from age 16 to present</p>
            </div>
          </div>
          <div class="no-print" style="position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <button onclick="window.print()" style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-bottom: 10px; width: 100%;">
              Save as PDF / Print
            </button>
            <button onclick="window.close()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%;">
              Close
            </button>
          </div>
        </body>
      </html>
    `;

    return content;
  };

  const generatePDF = () => {
    if (unsavedEntry) {
      alert('Please save your current entry before downloading');
      return;
    }
    
    checkForGaps();
    
    if (gaps.length > 0) {
      alert('Please fill all employment gaps before downloading your CV');
      return;
    }

    const content = generatePDFContent();
    const printWindow = window.open('', '_blank');
    printWindow.document.write(content);
    printWindow.document.close();
  };

  const shareCV = async () => {
    if (unsavedEntry) {
      alert('Please save your current entry before sharing');
      return;
    }
    
    checkForGaps();
    
    if (gaps.length > 0) {
      alert('Please fill all employment gaps before sharing your CV');
      return;
    }

    const content = generatePDFContent();
    const blob = new Blob([content], { type: 'text/html' });
    const file = new File([blob], `${personalInfo.fullName.replace(/\s+/g, '_')}_CV.html`, { type: 'text/html' });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          title: `${personalInfo.fullName} - CV`,
          text: `CV for ${personalInfo.fullName}`,
          files: [file]
        });
      } catch (err) {
        if (err.name !== 'AbortError') {
          fallbackShare();
        }
      }
    } else {
      fallbackShare();
    }
  };

  const fallbackShare = () => {
    const content = generatePDFContent();
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const shareText = `${personalInfo.fullName} - CV\n\nEmail: ${personalInfo.email}\nPhone: ${personalInfo.phone}`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '\n\nDownload CV: ' + window.location.href)}`;
    const emailUrl = `mailto:?subject=${encodeURIComponent(personalInfo.fullName + ' - CV')}&body=${encodeURIComponent(shareText)}`;
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
    modal.innerHTML = `
      <div style="background:white;padding:30px;border-radius:12px;max-width:400px;width:90%;">
        <h3 style="margin:0 0 20px 0;color:#1e40af;">Share Your CV</h3>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <a href="${whatsappUrl}" target="_blank" style="display:block;background:#25D366;color:white;padding:12px;border-radius:8px;text-decoration:none;text-align:center;font-weight:bold;">
            📱 Share via WhatsApp
          </a>
          <a href="${emailUrl}" style="display:block;background:#2563eb;color:white;padding:12px;border-radius:8px;text-decoration:none;text-align:center;font-weight:bold;">
            ✉️ Share via Email
          </a>
          <a href="${url}" download="${personalInfo.fullName.replace(/\s+/g, '_')}_CV.html" style="display:block;background:#10b981;color:white;padding:12px;border-radius:8px;text-decoration:none;text-align:center;font-weight:bold;">
            💾 Download HTML File
          </a>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:#6b7280;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
            Close
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
  };

  useEffect(() => {
    if (entries.length > 0 && !unsavedEntry) {
      checkForGaps();
    }
  }, [entries, personalInfo.dateOfBirth, unsavedEntry]);

  const employmentEntries = entries.filter(e => e.type !== 'education');
  const educationEntries = entries.filter(e => e.type === 'education');

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-xl p-8">
        <h1 className="text-3xl font-bold text-blue-900 mb-2">Continuous Employment CV Builder</h1>
        <p className="text-gray-600 mb-8">Track your complete work history from age 16 with no gaps</p>

        <div className="mb-8 p-6 bg-blue-50 rounded-lg">
          <h2 className="text-xl font-semibold text-blue-900 mb-4">Personal Information</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input
              type="text"
              placeholder="Full Name *"
              value={personalInfo.fullName}
              onChange={(e) => setPersonalInfo({...personalInfo, fullName: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <input
              type="email"
              placeholder="Email *"
              value={personalInfo.email}
              onChange={(e) => setPersonalInfo({...personalInfo, email: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <input
              type="tel"
              placeholder="Phone *"
              value={personalInfo.phone}
              onChange={(e) => setPersonalInfo({...personalInfo, phone: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <input
              type="text"
              placeholder="Postcode *"
              value={personalInfo.postcode}
              onChange={(e) => setPersonalInfo({...personalInfo, postcode: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <input
              type="text"
              placeholder="Address *"
              value={personalInfo.address}
              onChange={(e) => setPersonalInfo({...personalInfo, address: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent md:col-span-2"
            />
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
              <input
                type="date"
                value={personalInfo.dateOfBirth}
                onChange={(e) => handleDOBChange(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full"
              />
              {personalInfo.currentAge && (
                <div className="mt-2 text-sm">
                  <p className="text-gray-600">Current Age: {personalInfo.currentAge}</p>
                  <p className="text-blue-600 font-medium">You turned 16 on: {personalInfo.age16Date}</p>
                  <p className="text-orange-600 mt-1">⚠️ No gap should exceed 14 days between entries</p>
                </div>
              )}
            </div>
          </div>
        </div>

        {showSavePrompt && unsavedEntry && (
          <div className="mb-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
            <p className="text-yellow-800 font-semibold">⚠️ You have unsaved changes. Please save your entry before proceeding.</p>
          </div>
        )}

        {gaps.length > 0 && !unsavedEntry && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex items-start">
              <AlertCircle className="text-red-600 mr-3 mt-1 flex-shrink-0" size={20} />
              <div className="flex-1">
                <h3 className="font-semibold text-red-900 mb-2">Employment Gaps Detected</h3>
                {gaps.map((gap, index) => (
                  <div key={index} className="flex justify-between items-center mb-2 flex-wrap gap-2">
                    <p className="text-red-800 text-sm">
                      Gap from {gap.start} to {gap.end} ({gap.days} days)
                    </p>
                    <button
                      onClick={() => fillGapWithSuggestion(gap)}
                      className="flex items-center gap-1 bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 transition"
                    >
                      <Lightbulb size={14} />
                      Suggest
                    </button>
                  </div>
                ))}
                <p className="text-red-700 text-sm mt-2">
                  Please add entries to cover these periods or use our smart suggestions
                </p>
              </div>
            </div>
          </div>
        )}

        {showGapSuggestions && currentGap && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg p-6 max-w-md w-full">
              <h3 className="text-lg font-bold text-blue-900 mb-4">Smart Gap Suggestion</h3>
              <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-sm text-gray-700 mb-2">
                  <strong>Gap Period:</strong> {currentGap.start} to {currentGap.end} ({currentGap.days} days)
                </p>
                <p className="text-sm text-gray-700 mb-2">
                  <strong>Suggested Type:</strong> <span className="capitalize">{currentGap.suggestion.type}</span>
                </p>
                <p className="text-sm text-gray-700 mb-2">
                  <strong>Title:</strong> {currentGap.suggestion.title}
                </p>
                <p className="text-sm text-gray-700">
                  <strong>Description:</strong> {currentGap.suggestion.description}
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={applyGapSuggestion}
                  className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold"
                >
                  Apply Suggestion
                </button>
                <button
                  onClick={() => {
                    setShowGapSuggestions(false);
                    setCurrentGap(null);
                  }}
                  className="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition font-semibold"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        <div className="mb-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-semibold text-blue-900">Employment History</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setShowCustomTypeModal(true)}
                className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm disabled:bg-gray-400"
                disabled={unsavedEntry}
              >
                + Custom Type
              </button>
              <button
                onClick={addEntry}
                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400"
                disabled={unsavedEntry}
              >
                <Plus size={20} />
                Add Entry
              </button>
            </div>
          </div>

          {personalInfo.age16Date && entries.length === 0 && (
            <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <p className="text-blue-800 text-sm">
                📅 <strong>Start your first entry from: {personalInfo.age16Date}</strong> (when you turned 16)
              </p>
              <p className="text-blue-700 text-sm mt-1">
                Click "Add Entry" to begin. Start with your most recent/current position.
              </p>
            </div>
          )}

          {showCustomTypeModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 className="text-lg font-bold text-blue-900 mb-4">Add Custom Entry Type</h3>
                <input
                  type="text"
                  placeholder="e.g., Career Break, Internship, etc."
                  value={newCustomType}
                  onChange={(e) => setNewCustomType(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && addCustomType()}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4"
                />
                <div className="flex gap-3">
                  <button
                    onClick={addCustomType}
                    className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold"
                  >
                    Add Type
                  </button>
                  <button
                    onClick={() => {
                      setShowCustomTypeModal(false);
                      setNewCustomType('');
                    }}
                    className="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition font-semibold"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}

          {employmentEntries.map((entry) => (
            <div key={entry.id} className={`mb-6 p-6 rounded-lg border-2 ${entry.isNew ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'}`}>
              <div className="flex justify-between items-start mb-4">
                <select
                  value={entry.type}
                  onChange={(e) => updateEntry(entry.id, 'type', e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 capitalize"
                >
                  {allTypes.filter(t => t !== 'education').map(type => (
                    <option key={type} value={type} className="capitalize">{type}</option>
                  ))}
                </select>
                <button
                  onClick={() => deleteEntry(entry.id)}
                  className="text-red-600 hover:text-red-800"
                >
                  <Trash2 size={20} />
                </button>
              </div>

              {getNextExpectedDate() && entry.id === unsavedEntry && (
                <div className="mb-4 p-3 bg-blue-100 border border-blue-300 rounded text-sm">
                  <p className="text-blue-900">
                    📅 <strong>Expected start date: {getNextExpectedDate()}</strong>
                  </p>
                  <p className="text-blue-800 mt-1">
                    Your start date should be within 14 days of this date to avoid gaps
                  </p>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input
                  type="text"
                  placeholder="Job Title / Activity *"
                  value={entry.title}
                  onChange={(e) => updateEntry(entry.id, 'title', e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="text"
                  placeholder="Company / Institution *"
                  value={entry.company}
                  onChange={(e) => updateEntry(entry.id, 'company', e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <input
                  type="text"
                  placeholder="Location"
                  value={entry.location}
                  onChange={(e) => updateEntry(entry.id, 'location', e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm text-gray-700 mb-1">Start Date *</label>
                  <input
                    type="date"
                    value={entry.startDate}
                    onChange={(e) => updateEntry(entry.id, 'startDate', e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-full"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-700 mb-1">End Date *</label>
                  <div className="flex items-center gap-2">
                    <input
                      type="date"
                      value={entry.endDate}
                      onChange={(e) => updateEntry(entry.id, 'endDate', e.target.value)}
                      disabled={entry.isCurrent}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 flex-1 disabled:bg-gray-100"
                    />
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={entry.isCurrent}
                        onChange={(e) => updateEntry(entry.id, 'isCurrent', e.target.checked)}
                        className="w-4 h-4"
                      />
                      Current
                    </label>
                  </div>
                </div>
              </div>

              <textarea
                placeholder="Description of responsibilities, achievements, or activities... *"
                value={entry.description}
                onChange={(e) => updateEntry(entry.id, 'description', e.target.value)}
                rows="3"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4"
              />

              {entry.isNew && (
                <button
                  onClick={() => saveEntry(entry.id)}
                  className="w-full flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-semibold"
                >
                  <Save size={20} />
                  Save Entry
                </button>
              )}
            </div>
          ))}
        </div>

        {educationEntries.length > 0 && (
          <div className="mb-6">
            <h2 className="text-xl font-semibold text-blue-900 mb-4">Education</h2>
            {educationEntries.map((entry) => (
              <div key={entry.id} className={`mb-6 p-6 rounded-lg border-2 ${entry.isNew ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'}`}>
                <div className="flex justify-between items-start mb-4">
                  <select
                    value={entry.type}
                    onChange={(e) => updateEntry(entry.id, 'type', e.target.value)}
                    className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 capitalize"
                  >
                    {allTypes.map(type => (
                      <option key={type} value={type} className="capitalize">{type}</option>
                    ))}
                  </select>
                  <button
                    onClick={() => deleteEntry(entry.id)}
                    className="text-red-600 hover:text-red-800"
                  >
                    <Trash2 size={20} />
                  </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <input
                    type="text"
                    placeholder="Course / Qualification *"
                    value={entry.title}
                    onChange={(e) => updateEntry(entry.id, 'title', e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                  <input
                    type="text"
                    placeholder="Institution *"
                    value={entry.company}
                    onChange={(e) => updateEntry(entry.id, 'company', e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                  <input
                    type="text"
                    placeholder="Location"
                    value={entry.location}
                    onChange={(e) => updateEntry(entry.id, 'location', e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm text-gray-700 mb-1">Start Date *</label>
                    <input
                      type="date"
                      value={entry.startDate}
                      onChange={(e) => updateEntry(entry.id, 'startDate', e.target.value)}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-full"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-700 mb-1">End Date *</label>
                    <div className="flex items-center gap-2">
                      <input
                        type="date"
                        value={entry.endDate}
                        onChange={(e) => updateEntry(entry.id, 'endDate', e.target.value)}
                        disabled={entry.isCurrent}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 flex-1 disabled:bg-gray-100"
                      />
                      <label className="flex items-center gap-2 text-sm">
                        <input
                          type="checkbox"
                          checked={entry.isCurrent}
                          onChange={(e) => updateEntry(entry.id, 'isCurrent', e.target.checked)}
                          className="w-4 h-4"
                        />
                        Current
                      </label>
                    </div>
                  </div>
                </div>

                <textarea
                  placeholder="Description of course, achievements, grades... *"
                  value={entry.description}
                  onChange={(e) => updateEntry(entry.id, 'description', e.target.value)}
                  rows="3"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4"
                />

                {entry.isNew && (
                  <button
                    onClick={() => saveEntry(entry.id)}
                    className="w-full flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-semibold"
                  >
                    <Save size={20} />
                    Save Entry
                  </button>
                )}
              </div>
            ))}
          </div>
        )}

        <div className="flex gap-4 flex-wrap">
          <button
            onClick={generatePDF}
            className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold disabled:bg-gray-400"
            disabled={unsavedEntry}
          >
            <Download size={20} />
            Download CV
          </button>
          <button
            onClick={shareCV}
            className="flex items-center gap-2 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold disabled:bg-gray-400"
            disabled={unsavedEntry}
          >
            <Share2 size={20} />
            Share CV
          </button>
          <button
            onClick={checkForGaps}
            className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold"
          >
            Check for Gaps
          </button>
        </div>

        {gaps.length === 0 && entries.length > 0 && personalInfo.dateOfBirth && !unsavedEntry && (
          <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p className="text-green-800 font-semibold">✓ No gaps detected! Your employment history is complete.</p>
          </div>
        )}
      </div>
    </div>
  );
}
